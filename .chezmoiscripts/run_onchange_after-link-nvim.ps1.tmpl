# run_after_link-nvim.ps1.tmpl

# Failsafe: Ensure we're running in PowerShell 7+
if ($PSVersionTable.PSVersion.Major -lt 7) {
    Write-Error "This script requires PowerShell 7 or later. Current version: $($PSVersionTable.PSVersion)"
    Write-Error "Configure chezmoi with: [interpreters.ps1] command = 'pwsh'"
    exit 1
}

$sourceProfile = [System.IO.Path]::GetFullPath("$Env:USERPROFILE\.config\nvim")
$targetProfile = [System.IO.Path]::GetFullPath("$Env:LOCALAPPDATA\nvim")

if (!(Test-Path $sourceProfile)) {
    Write-Error "chezmoi didn't create $sourceProfile?"
    exit 1
}

if ((Test-Path $targetProfile) -and ((Get-Item $targetProfile).LinkTarget -eq $sourceProfile)) {
    Write-Host "nvim config exist: $targetProfile -> $sourceProfile"
    return
} else {
    if (Test-Path $targetProfile) {
        Remove-Item $targetProfile -Force -Recurse
    }
    New-Item -ItemType SymbolicLink -Path $targetProfile -Target $sourceProfile
    Write-Host "nvim config created : $targetProfile -> $sourceProfile"
}
